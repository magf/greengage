substitutions:
  _IMAGE_VERSION: "6"  # Default
  _IMAGE: "europe-west1-docker.pkg.dev/${PROJECT_ID}/greengage/ggdb${_IMAGE_VERSION}_u22"

steps:
# Step 1: Update Git submodules
- name: 'gcr.io/cloud-builders/git'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    git fetch --unshallow --tags || git fetch --tags --depth=0
    git submodule update --init --recursive
  env:
  - 'GIT_DEPTH=1000'

# Step 2: Build&Push  Docker image
- name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    image="$_IMAGE:$(echo "$BRANCH_NAME" | tr '/' '_')"
    docker build --file ci/Dockerfile.ubuntu.build --build-arg PROJECT_ID=$PROJECT_ID --tag $image .
    docker push $image

images:
- "$_IMAGE"

options:
  logging: CLOUD_LOGGING_ONLY
