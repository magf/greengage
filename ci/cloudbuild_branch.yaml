substitutions:
  _IMAGE_VERSION: "7"  # Default
  _IMAGE: "europe-west4-docker.pkg.dev/${PROJECT_ID}/greengage/gpdb${_IMAGE_VERSION}_u22"

steps:
# Step 1: Update Git submodules
- name: 'gcr.io/cloud-builders/git'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    git submodule update --init --recursive
  env:
  - 'GIT_DEPTH=1000'

# Step 2: Build&Push  Docker image
- name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    image="$_IMAGE:${BRANCH_NAME/\//_}"
    docker build -f ci/Dockerfile.ubuntu \
      -t $image .
    docker push $image

images:
- "$_IMAGE"

options:
  logging: CLOUD_LOGGING_ONLY
